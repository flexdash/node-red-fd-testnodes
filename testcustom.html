<!-- FlexDash TestCustom node for Node-RED
     Copyright (c) 2022 by Thorsten von Eicken, see LICENSE -->

<script type="text/javascript">

  const sourceTemplate = /* <!-- */ `// Simplified button widget as starting point for your own custom widget

<template>
  <div class="pushbutton d-flex align-center justify-center">
    <v-btn large dense class="ma-auto" max-width="95%" v-bind="bindings" @click="clickEv($event)">
      <span>{{ title }}</span>
    </v-btn>
  </div>
</template>

<style scoped>
  .pushbutton { height: 100%; }
</style>

<script scoped>
export default {
  // help displayed in the UI: the first line is used in the widgets menu and is always shown in
  // the edit card. Successive lines can be expanded in the card and are markdown-formatted.
  help: \`Custom widget, it could do anything.
Pressing the button sends a message with a specified payload to a topic.
The button may contain a title string and is centered in the widget.\`,

  // properties are inputs to the widget. The type is used to display the appropriate kind of input
  // field and also to convert data (ex: string to number).
  props: {
    enabled: { type: Boolean, default: true, tip: "enable/disable button" },
    color: { type: String, default: "primary", tip: "button color" },
    output_value: { default: "click", tip: "value sent on click" },
    title: { type: String, default: 'Button', tip: "text shown in button" },
  },

  // the presence of an output field is used by FlexDash to allow the widget to output messages
  output: { default: null },

  computed: {
    // actual bindings passed into v-btn
    bindings() { return {
      disabled: !this.enabled,
      color: this.color,
    }},

  },

  methods: {
    clickEv(ev) {
      this.$emit('send', this.output_value)
    },
  },
}
</script>
` /* --> */


  RED.nodes.registerType('flexdash testcustom', {
    // properties of the NR node used by NR itself
    category: 'flexdash',
    color: "#FDF0C2",
    inputs: 1,
    outputs: 1,
    icon: "font-awesome/fa-rocket", // icon in flow editor
    paletteLabel: "FD testcustom",

    // node config properties that the user can edit in the flow editor
    defaults: {
      // required fields for FlexDash Widget nodes
      fd: { type:"flexdash config", value:"", required:true }, // FlexDash config node
      name: { value: '' }, // name field of NR node (standard)

      payload: { value: 'title' }, // to which param the NR msg.payload should be mapped
      source: { value: sourceTemplate }, // source code for the widget
    },

    // NR node label
    label() { return this.name || "flexdash testcustom" },
    labelStyle() { return this.name ? "node_label_italic" : "" },

    oneditprepare() {
      this.editor = RED.editor.createEditor({
        id: 'node-input-source-editor',
        mode: 'ace/mode/text',
        value: this.source
      })
    },

    oneditsave() {
      this.source = this.editor.getValue()
      this.editor.destroy()
      delete this.editor
    },

    oneditcancel() {
        this.editor.destroy()
        delete this.editor
    },

    oneditresize(size) { // gathered from function node source
      const rows = $("#dialog-form>div:not(.node-text-editor-row)");
      let height = $("#dialog-form").height();
      for (var i=0; i<rows.length; i++) {
          height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
      $("#dialog-form .node-text-editor").css("height", height+"px");

      this.editor.resize();
    },
  });
</script>

<script type="text/html" data-template-name="flexdash testcustom">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-fd"><i class="fa fa-tag"></i> Dashboard</label>
    <input type="text" id="node-input-fd">
  </div>
  <div class="form-row" style="margin-top: 12px">
    <label for="node-input-payload"><i class="icon-tag"></i> Payload param</label>
    <input type="text" id="node-input-payload" placeholder="Name of param">
    <br>
    <small >Name of the param to which the msg.payload of incoming messages should be mapped.</small>
  </div>
  <div class="form-row node-text-editor-row" style="position:relative">
    <div style="height: 220px; min-height:150px;" class="node-text-editor"
         id="node-input-source-editor" >
    </div>
  </div>
</script>

<script type="text/html" data-help-name="flexdash testcustom">
  <p>Creates a custom widget in the FlexDash dashboard.</p>
</script>
